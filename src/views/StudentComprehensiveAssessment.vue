<!--
 * @Author: STATICHIT 2394412110@qq.com
 * @Date: 2023-11-06 22:50:19
 * @LastEditors: STATICHIT 2394412110@qq.com
 * @LastEditTime: 2024-03-31 15:56:24
 * @FilePath: \collegeApplication\src\views\StudentComprehensiveAssessment.vue
 * @Description: å­¦ç”Ÿä¸ªäººç»¼æµ‹æŸ¥çœ‹é¡µé¢
-->
<template>
  <div class="show-container">
    <div class="title">
      <div class="text">ä¸ªäººç»¼æµ‹æŸ¥çœ‹</div>
    </div>
    <hr />
    <br />
    <!-- æç¤ºå’Œé€‰é¡¹ç»„ -->
    <div>
      <div class="tip">
        <span>è¯·æ³¨æ„æ£€æŸ¥ç»¼æµ‹æƒ…å†µï¼Œå¦‚æœ‰é”™è¯¯è¯·åŠæ—¶å‘æµ‹è¯„å°ç»„è¿›è¡Œç”³è¯‰ã€‚</span
        ><br />
        <span>è¯·åœ¨å¯¹æœ¬æœˆæœ€ç»ˆçš„æ•´ä½“ç»¼æµ‹æƒ…å†µç¡®è®¤æ— è¯¯åå†è¿›è¡Œç”µå­ç­¾åã€‚</span>
      </div>
      <br />
      <el-button type="primary" @click="data.dialogVisible3 = true"
        >ç”³è¯‰å†å²</el-button
      >
      <el-button type="danger" @click="data.dialogVisible2 = true"
        >ç”³æŠ¥é”™è¯¯</el-button
      >
      <br />
      <br />
      <!-- é€‰æ‹©æ¡†,æ ‡é¢˜ -->
      <div>
        <span>è¯·é€‰æ‹©æŸ¥è¯¢æœˆä»½ï¼š</span>
        <el-select
          v-model="data.month"
          :disabled="data.loadOk"
          placeholder="è¯·é€‰æ‹©æŸ¥è¯¢æœˆä»½"
          style="width: 200px"
          @change="getAssessmentDetails"
        >
          <el-option
            v-for="item in data.monthes"
            :key="item.value"
            :label="item.label"
            :value="item.value"
          />
        </el-select>
      </div>
      <br />
      <!-- è¯¥æœˆæƒ…å†µè¯¦ç»† -->
      <el-form-item label="è¯¥æœˆç¡®è®¤æƒ…å†µ ï¼š">
        <span v-show="data.signature">å·²ç¡®è®¤</span>
        <span v-show="data.signature == null">å¾…ç¡®è®¤</span>
        <span class="tip2">(å·²ç¡®è®¤/å¾…ç¡®è®¤)</span>
      </el-form-item>
    </div>
    <!-- ç»¼æµ‹æƒ…å†µè¯¦ç»† -->
    <div>
      <div>
        <h4>è¯¥æœˆç»¼æµ‹æƒ…å†µç¡®è®¤</h4>
        <br />
        <!-- æ‰‹æœºç«¯æ˜¾ç¤º -->
        <div class="phone">
          <el-form>
            <div>
              <el-form-item label="å§“å:" label-width="80px">{{
                data.myAssessment.username || "æš‚æ— æ•°æ®"
              }}</el-form-item>
              <el-form-item label="å­¦å·:" label-width="80px">{{
                data.myAssessment.userNumber || "æš‚æ— æ•°æ®"
              }}</el-form-item>
              <el-form-item label="å¾·è‚²æ˜ç»†:" label-width="80px"></el-form-item>
              <div class="detail">
                <el-form-item label="åŠ åˆ†æ˜ç»†" label-width="140px">
                  {{ data.myAssessment.add1 || "æš‚æ— æ•°æ®" }}
                </el-form-item>
                <el-form-item label="å‡åˆ†æ˜ç»†" label-width="140px">
                  {{ data.myAssessment.sub1 || "æš‚æ— æ•°æ®" }}
                </el-form-item>
                <el-form-item label="å¾·è‚²å¾—åˆ†" label-width="140px">
                  {{ data.myAssessment.point1 || "æš‚æ— æ•°æ®" }}
                </el-form-item>
              </div>
            </div>
            <div>
              <el-form-item label="æ™ºè‚²æ˜ç»†:" label-width="80px"></el-form-item>
              <div class="detail">
                <el-form-item label="åŠ åˆ†æ˜ç»†" label-width="140px">
                  {{ data.myAssessment.add2 || "æš‚æ— æ•°æ®" }}
                </el-form-item>
                <el-form-item label="å‡åˆ†æ˜ç»†" label-width="140px">
                  {{ data.myAssessment.sub2 || "æš‚æ— æ•°æ®" }}
                </el-form-item>
                <el-form-item label="æ™ºè‚²å¾—åˆ†" label-width="140px">
                  {{ data.myAssessment.point2 || "æš‚æ— æ•°æ®" }}
                </el-form-item>
              </div>
            </div>
            <div>
              <el-form-item label="ä½“è‚²æ˜ç»†:" label-width="80px"></el-form-item>
              <div class="detail">
                <el-form-item label="åŠ åˆ†æ˜ç»†" label-width="140px">
                  {{ data.myAssessment.add3 || "æš‚æ— æ•°æ®" }}
                </el-form-item>
                <el-form-item label="å‡åˆ†æ˜ç»†" label-width="140px">
                  {{ data.myAssessment.sub3 || "æš‚æ— æ•°æ®" }}
                </el-form-item>
                <el-form-item label="æ™ºè‚²å¾—åˆ†" label-width="140px">
                  {{ data.myAssessment.point3 || "æš‚æ— æ•°æ®" }}
                </el-form-item>
              </div>
            </div>
            <div>
              <el-form-item label="ç¾è‚²æ˜ç»†:" label-width="80px"></el-form-item>
              <div class="detail">
                <el-form-item label="åŠ åˆ†æ˜ç»†" label-width="140px">
                  {{ data.myAssessment.add4 || "æš‚æ— æ•°æ®" }}
                </el-form-item>
                <el-form-item label="å‡åˆ†æ˜ç»†" label-width="140px">
                  {{ data.myAssessment.sub4 || "æš‚æ— æ•°æ®" }}
                </el-form-item>
                <el-form-item label="æ™ºè‚²å¾—åˆ†" label-width="140px">
                  {{ data.myAssessment.point4 || "æš‚æ— æ•°æ®" }}
                </el-form-item>
              </div>
            </div>
            <div>
              <el-form-item label="åŠ³åŠ¨æ˜ç»†:" label-width="80px"></el-form-item>
              <div class="detail">
                <el-form-item label="åŠ åˆ†æ˜ç»†" label-width="140px">
                  {{ data.myAssessment.add5 || "æš‚æ— æ•°æ®" }}
                </el-form-item>
                <el-form-item label="å‡åˆ†æ˜ç»†" label-width="140px">
                  {{ data.myAssessment.sub5 || "æš‚æ— æ•°æ®" }}
                </el-form-item>
                <el-form-item label="æ™ºè‚²å¾—åˆ†" label-width="140px">
                  {{ data.myAssessment.point5 || "æš‚æ— æ•°æ®" }}
                </el-form-item>
              </div>
            </div>
            <br />
            <el-form-item label="æ€»ä½“æƒ…å†µ" label-width="80px"> </el-form-item>
            <div class="detail">
              <el-form-item label="æ€»åŠ åˆ†" label-width="140px">
                {{ data.myAssessment.add_total || "æš‚æ— æ•°æ®" }}
              </el-form-item>
              <el-form-item label="æ€»å‡åˆ†" label-width="140px">
                {{ data.myAssessment.sub_total || "æš‚æ— æ•°æ®" }}
              </el-form-item>
              <el-form-item label="æ€»å¾—åˆ†" label-width="140px">
                {{ data.myAssessment.point_total || "æš‚æ— æ•°æ®" }}
              </el-form-item>
            </div>
          </el-form>
        </div>
        <!-- pcç«¯æ˜¾ç¤º -->
        <el-table
          :data="data.assessment"
          v-loading.lock="data.loading"
          style="width: 100%"
          class="pc"
          default="æš‚æ— æ•°æ®"
        >
          <el-table-column prop="userNumber" label="å­¦å·" width="120" />
          <el-table-column prop="username" label="å§“å" width="150" />
          <el-table-column label="å¾·è‚²">
            <el-table-column prop="add1" label="åŠ åˆ†æ˜ç»†" width="120" />
            <el-table-column prop="sub1" label="å‡åˆ†æ˜ç»†" width="120" />
            <el-table-column prop="point1" label="å¾—åˆ†" width="60" />
          </el-table-column>
          <el-table-column label="æ™ºè‚²">
            <el-table-column prop="add2" label="åŠ åˆ†æ˜ç»†" width="120" />
            <el-table-column prop="sub2" label="å‡åˆ†æ˜ç»†" width="120" />
            <el-table-column prop="point2" label="å¾—åˆ†" width="60" />
          </el-table-column>
          <el-table-column label="ä½“è‚²">
            <el-table-column prop="add3" label="åŠ åˆ†æ˜ç»†" width="120" />
            <el-table-column prop="sub3" label="å‡åˆ†æ˜ç»†" width="120" />
            <el-table-column prop="point3" label="å¾—åˆ†" width="60" />
          </el-table-column>
          <el-table-column label="ç¾è‚²">
            <el-table-column prop="add4" label="åŠ åˆ†æ˜ç»†" width="120" />
            <el-table-column prop="sub4" label="å‡åˆ†æ˜ç»†" width="120" />
            <el-table-column prop="point4" label="å¾—åˆ†" width="60" />
          </el-table-column>
          <el-table-column label="åŠ³åŠ¨">
            <el-table-column prop="add5" label="åŠ åˆ†æ˜ç»†" width="120" />
            <el-table-column prop="sub5" label="å‡åˆ†æ˜ç»†" width="120" />
            <el-table-column prop="point5" label="å¾—åˆ†" width="60" />
          </el-table-column>
          <el-table-column label="å½“æœˆç»¼åˆæµ‹è¯„å¾—åˆ†" fixed="right">
            <el-table-column prop="add_total" label="æœˆåŠ åˆ†" width="50" />
            <el-table-column prop="sub_total" label="æœˆå‡åˆ†" width="50" />
            <el-table-column prop="pre_total" label="ä¸Šæœˆå¾—åˆ†" width="50" />
            <el-table-column prop="point_total" label="å½“æœˆæ€»åˆ†" width="50" />
          </el-table-column>
        </el-table>
        <br />
      </div>
      <el-button
        type="primary"
        @click="data.dialogVisible = true"
        :disabled="!(data.signature == null)"
        >å‰å¾€ç”µå­ç­¾å</el-button
      >
      <br />
    </div>
  </div>
  <!-- ç”µå­ç­¾åå¯¹è¯æ¡† -->
  <el-dialog v-model="data.dialogVisible" title="ç”µå­ç­¾å" :width="data.width1">
    <div>
      <div class="tip3">
        è¯¥ç”µå­ç­¾åä¸ºç¡®ä¿ç»¼æµ‹ä¿¡æ¯ç»è¿‡æœ¬äººç¡®è®¤åæ— è¯¯
      </div>
      <signatures @finish="finish"></signatures>
    </div>
  </el-dialog>
  <!-- ç”³æŠ¥é”™è¯¯å¯¹è¯æ¡† -->
  <el-dialog
    v-model="data.dialogVisible2"
    title="ç”³æŠ¥é”™è¯¯"
    :width="data.width2"
  >
    <div>
      <el-form-item label="ç”³è¯‰é—®é¢˜ç±»å‹ï¼š">
        <el-select
          v-model="data.type"
          class="m-2"
          placeholder="è¯·é€‰æ‹©ç”³æŠ¥é—®é¢˜ç±»å‹"
        >
          <el-option
            v-for="item in data.types"
            :key="item.value"
            :label="item.label"
            :value="item.value"
          />
        </el-select>
      </el-form-item>
      <el-form-item label="é”™è¯¯ç”³æŠ¥å†…å®¹ï¼š">
        <el-input
          v-model="data.content"
          :autosize="{ minRows: 6, maxRows: 10 }"
          type="textarea"
          placeholder="è¯·è¾“å…¥é”™è¯¯ç”³æŠ¥å†…å®¹"
        />
      </el-form-item>
    </div>
    <template #footer>
      <span class="dialog-footer">
        <el-button type="primary" @click="commit"> æäº¤ç”³æŠ¥ </el-button>
      </span>
    </template>
  </el-dialog>
  <!-- ç”³è¯‰å†å²å¯¹è¯æ¡† -->
  <el-dialog
    v-model="data.dialogVisible3"
    title="ğŸ’¬ å¾…ç”³è¿°å¤„ç†"
    :width="data.width3"
  >
    <div>
      <el-table :data="data.complaintData" style="width: 100%">
        <el-table-column type="index" />
        <el-table-column label="ç”³è¯‰é—®é¢˜ç±»å‹" min-width="120">
          <template #default="scope">
            <span v-if="scope.row.type == false">ç»¼æµ‹é—®é¢˜</span>
            <span v-if="scope.row.type == true">ä¿¡æ¯/å¿—æ„¿é—®é¢˜</span>
          </template>
        </el-table-column>
        <el-table-column label="ç”³è¯‰å†…å®¹" prop="content" min-width="300" />
        <el-table-column label="ç”³è¯‰æ—¶é—´" prop="created" min-width="200" />
        <el-table-column
          label="ç”³è¯‰çŠ¶æ€"
          width="100"
          :filters="[
            { text: 'å¤„ç†ä¸­', value: '0' },
            { text: 'å·²å¤„ç†', value: '1' },
            { text: 'å·²æ’¤é”€', value: '2' },
          ]"
          :filter-method="filterTag"
          filter-placement="bottom-end"
        >
          <template #default="scope">
            <el-tag
              :type="
                scope.row.state === 0
                  ? ''
                  : scope.row.state === 1
                  ? 'success'
                  : 'info'
              "
              disable-transitions
            >
              <span v-if="scope.row.state == 0">å¤„ç†ä¸­</span>
              <span v-if="scope.row.state == 1">å·²å¤„ç†</span>
              <span v-if="scope.row.state == 2">å·²æ’¤é”€</span>
            </el-tag>
          </template>
        </el-table-column>
        <el-table-column label="æ“ä½œ" min-width="150">
          <template #default="scope">
            <el-button
              v-if="scope.row.state == 1 || scope.row.state == 2"
              size="small"
              type="danger"
              @click="handleDelete(scope.$index, scope.row)"
              >åˆ é™¤</el-button
            >
            <el-button
              v-if="scope.row.state == 0"
              size="small"
              @click="handleRevoke(scope.$index, scope.row)"
              >æ’¤é”€</el-button
            >
          </template>
        </el-table-column>
      </el-table>
    </div>
  </el-dialog>
</template>
<script setup>
import signatures from "@/components/utils/Signatures.vue";
import { reactive, onMounted } from "vue";
import { ElMessage } from "element-plus";
import studentFun from "@/api/student";
import { getMonthName } from "@/assets/js/utils/month";
const data = reactive({
  width1: "80%",
  width2: "50%",
  width3: "60%",
  myAssessment: {
    userNumber: "",
    username: "",
    add1: "",
    sub1: "",
    point1: 0,
    add2: "",
    sub2: "",
    point2: 0,
    add3: "",
    sub3: "æ— ",
    point3: 0,
    add4: "",
    sub4: "",
    point4: 0,
    add5: "",
    sub5: "",
    point5: 0,
    add_total: 0,
    sub_total: 0,
    pre_total: 0,
    point_total: 0,
  },
  assessment: [],
  state: null,
  month: null, //å½“å‰ç¡®è®¤ç»¼æµ‹çš„æœˆä»½
  score: null, //ç›®å‰æ€»åˆ†
  signature: "xx", //ç­¾å
  isEnd: null,
  types: [
    {
      value: false,
      label: "ç»¼æµ‹é—®é¢˜",
    },
    {
      value: true,
      label: "ä¿¡æ¯/å¿—æ„¿é—®é¢˜",
    },
  ],
  type: "", //ç”³è¯‰ç±»å‹
  content: "", //ç”³è¯‰å†…å®¹
  complaintData: [], // ç”³è¯‰åˆ—è¡¨
  monthes: [],
  loading: false,
  loadOk: true,
  dialogVisible: false,
  dialogVisible2: false,
  dialogVisible3: false,
});
onMounted(() => {
  init();
});
//åˆå§‹åŒ–
function init() {
  // æ·»åŠ  resize äº‹ä»¶ç›‘å¬å™¨
  window.addEventListener("resize", watchWidth);
  watchWidth();
  getAssessmentThisMonth();
  getAssessmentMonth();
  getComplaintHistory();
}
//ç›‘å¬å®½åº¦
function watchWidth() {
  if (document.documentElement.clientWidth <= 1100) {
    data.width1 = "80%";
    data.width2 = "60%";
    data.width3 = "90%";
  } else {
    data.width1 = "50%";
    data.width2 = "30%";
    data.width3 = "60%";
  }
}
//è·å–æœ¬æœˆç»¼æµ‹æƒ…å†µ
function getAssessmentThisMonth() {
  data.loading = true;
  data.loadOk = true;
  studentFun.assess.getAssessmentThisMonth().then((res) => {
    data.isEnd = res.isEnd;
    data.month = res.month;
    data.score = res.score;
    data.signature = res.signature;
    data.assessment = [res.content];
    data.myAssessment = res.content;
    data.loading = false;
    data.loadOk = false;
  });
}
//æŒ‰æœˆä»½è·å–ç»¼æµ‹æƒ…å†µ
function getAssessmentDetails() {
  data.loading = true;
  studentFun.assess
    .getAssessmentByMonth({
      month: data.month,
    })
    .then((res) => {
      data.isEnd = res.isEnd;
      data.month = res.month;
      data.score = res.score;
      data.signature = res.signature;
      data.assessment = [res.content];
      data.myAssessment = res.content;
      data.loading = false;
    });
}
//è·å–å¯é€‰æœˆä»½æ–¹æ³•
function getAssessmentMonth() {
  studentFun.assess.studentGetMonthes().then((res) => {
    res.forEach((item) => {
      data.monthes.push({
        value: item,
        label: getMonthName(item),
      });
    });
  });
}
//è·å–ç”³è¯‰å†å²
function getComplaintHistory() {
  studentFun.complaint
    .getComplaints({
      state: "",
      current: 1,
      size: 1000,
    })
    .then((res) => {
      data.complaintData = res.reverse();
    });
}
//æäº¤ç”³æŠ¥
function commit() {
  if (data.type === "" || data.content === "") {
    ElMessage({
      message: "è¯·é€‰æ‹©ç”³è¯‰ç±»å‹æˆ–å¡«å†™ç”³è¯‰å†…å®¹",
      type: "error",
    });
  } else {
    studentFun.complaint
      .submitComplaint({
        content: data.content,
        type: data.type,
      })
      .then((res) => {
        data.dialogVisible2 = false;
        getComplaintHistory();
        data.content = "";
        data.type = "";
        ElMessage({
          message: "å·²ç”³æŠ¥é”™è¯¯ï¼Œè¯·è€å¿ƒç­‰å¾…å¤„ç†",
          type: "success",
        });
      });
  }
}
//ç­›é€‰å™¨
const filterTag = (value, row) => {
  return row.state == value;
};
//åˆ é™¤ï¼ˆå¤„ç†ä¸­/å·²å–æ¶ˆï¼‰ç”³è¯‰é¡¹
const handleDelete = (index, row) => {
  studentFun.complaint.deleteComplaint([row.appealId]).then((res) => {
    data.complaintData.splice(index, 1);
    ElMessage.success(res);
  });
};
//æ’¤é”€å¤„ç†ä¸­çš„ç”³è¯‰é¡¹
const handleRevoke = (index, row) => {
  studentFun.complaint.revokeComplaint(row.appealId).then((res) => {
    row.state = 2;
    ElMessage.success(res);
  });
};
//ç­¾ååæäº¤æ•°æ®å’Œç”µå­ç­¾å
function finish(file) {
  const formData = new FormData();
  formData.append("file", file);
  studentFun.sign.studentConfirmSign(data.month, formData).then((res) => {
    data.signature = "ABC"; //ä¸ä¸ºç©ºå³å¯
    data.dialogVisible = false;
    ElMessage({
      message: "ç¡®è®¤æœ¬æœˆç»¼æµ‹æƒ…å†µæˆåŠŸ",
      type: "success",
    });
  });
}
</script>
<style src="@/assets/css/show-container.css" scoped></style>
<style src="@/assets/css/student/studentComprehensiveAssessment.scss" lang="scss" scoped/>